<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TurnoYA - Encuentra o publica trabajos f√°cilmente</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #007bff;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      padding: 20px;
    }

    .form-section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input, select, button, textarea {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #0056b3;
    }

    #logoutBtn {
      background-color: #dc3545;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      display: none;
    }

    #logoutBtn:hover {
      background-color: #c82333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    .hidden {
      display: none;
    }

    /* Modal de postulaci√≥n */
    #formPostulacion {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 400px;
      z-index: 1000;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 500;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin: 0;">TurnoYA</h1>
      <p style="margin: 0;">Encuentra o publica trabajos f√°cilmente</p>
    </div>
    <button id="logoutBtn" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </header>

  <main>

    <!-- üîê LOGIN Y REGISTRO -->
    <div id="auth-section" class="form-section">
      <h2>Iniciar sesi√≥n / Registrarse</h2>
      <input type="text" id="usuario" placeholder="Usuario" required>
      <input type="password" id="contrasena" placeholder="Contrase√±a" required>
      <select id="rol">
        <option value="trabajador">Trabajador</option>
        <option value="empresa">Empresa</option>
      </select>
      <br>
      <button onclick="login()">Iniciar sesi√≥n</button>
      <button onclick="registrar()">Registrarse</button>
      <p id="auth-msg"></p>
    </div>

    <!-- üîç BUSCADOR DE TURNOS -->
    <div id="buscador-section" class="form-section hidden">
      <h2>Buscar Turnos</h2>
      <input type="text" id="ciudad" placeholder="Ciudad">
      <select id="categoria">
        <option value="">Seleccione categor√≠a</option>
        <option value="Eventos">Eventos</option>
        <option value="T√©cnico">T√©cnico</option>
        <option value="Hogar">Hogar</option>
        <option value="Log√≠stica">Log√≠stica</option>
        <option value="Atenci√≥n">Atenci√≥n</option>
      </select>
      <input type="number" id="pagoMin" placeholder="Pago m√≠nimo">
      <button onclick="buscarTurnos()">Buscar</button>
      <table id="tablaTurnos">
        <thead>
          <tr>
            <th>T√≠tulo</th>
            <th>Categor√≠a</th>
            <th>Fecha</th>
            <th>Direcci√≥n</th>
            <th>Ciudad</th>
            <th>Pago</th>
            <th>Empresa</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- üè¢ FORMULARIO PARA PUBLICAR NUEVO TURNO (solo empresas) -->
    <div id="publicar-section" class="form-section hidden">
      <h2>Publicar nuevo turno</h2>
      <input type="text" id="titulo" placeholder="T√≠tulo del trabajo" required><br>
      <select id="categoriaPub">
        <option value="">Seleccione categor√≠a</option>
        <option value="Eventos">Eventos</option>
        <option value="T√©cnico">T√©cnico</option>
        <option value="Hogar">Hogar</option>
        <option value="Log√≠stica">Log√≠stica</option>
        <option value="Atenci√≥n">Atenci√≥n</option>
      </select><br>
      <input type="date" id="fecha" required><br>
      <input type="text" id="direccion" placeholder="Direcci√≥n" required><br>
      <input type="text" id="ciudadPub" placeholder="Ciudad" required><br>
      <input type="number" id="pago" placeholder="Pago" required><br>
      <textarea id="descripcion" placeholder="Descripci√≥n del trabajo"></textarea><br>
      <button onclick="crearTurno()">Publicar</button>
      <p id="pub-msg"></p>
    </div>

    <!-- üìã FORMULARIO DE POSTULACI√ìN (modal) -->
    <div id="overlay" class="hidden" onclick="cerrarFormulario()"></div>
    <div id="formPostulacion" class="hidden">
      <h3>Formulario de Postulaci√≥n</h3>
      <input type="hidden" id="turnoId">
      <input type="text" id="nombre" placeholder="Nombre completo">
      <input type="email" id="email" placeholder="Correo electr√≥nico">
      <input type="text" id="telefono" placeholder="Tel√©fono">
      <textarea id="experiencia" placeholder="Experiencia o habilidades"></textarea>
      <textarea id="comentarios" placeholder="Comentarios adicionales"></textarea>
      <br>
      <button onclick="enviarPostulacion()">Enviar</button>
      <button onclick="cerrarFormulario()">Cancelar</button>
      <p id="post-msg"></p>
    </div>

    <!-- üìÑ SECCI√ìN DE POSTULACIONES (solo empresa) -->
    <div id="postulaciones-section" class="form-section hidden">
      <h2>Postulaciones Recibidas</h2>
      <table id="tablaPostulaciones">
        <thead>
          <tr>
            <th>Turno</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Experiencia</th>
            <th>Comentarios</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </main>

  <script>
    const API_URL = "https://turnoya-app.onrender.com";
    let usuarioActual = null;

    async function login() {
      const nombreUsuario = document.getElementById("usuario").value;
      const contrasena = document.getElementById("contrasena").value;
      const rol = document.getElementById("rol").value;

      const resp = await fetch(`${API_URL}/usuarios/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombreUsuario, contrasena })
      });

      const data = await resp.json();

      if (data && data.nombreUsuario) {
        usuarioActual = data;
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("buscador-section").classList.remove("hidden");
        document.getElementById("logoutBtn").style.display = "inline-block";

        if (data.rol === "empresa") {
          document.getElementById("publicar-section").classList.remove("hidden");
          document.getElementById("postulaciones-section").classList.remove("hidden");
          cargarPostulaciones();
        }

        buscarTurnos();
      } else {
        document.getElementById("auth-msg").textContent = "Usuario o contrase√±a incorrectos";
      }
    }

    async function registrar() {
      const nombreUsuario = document.getElementById("usuario").value;
      const contrasena = document.getElementById("contrasena").value;
      const rol = document.getElementById("rol").value;

      const resp = await fetch(`${API_URL}/usuarios/registrar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombreUsuario, contrasena, rol })
      });

      const msg = await resp.text();
      document.getElementById("auth-msg").textContent =
        msg === "EXISTE" ? "‚ùå El usuario ya existe." : "‚úÖ Registro exitoso.";
    }

    async function buscarTurnos() {
      const ciudad = document.getElementById("ciudad").value;
      const categoria = document.getElementById("categoria").value;
      const pagoMin = document.getElementById("pagoMin").value;

      const params = new URLSearchParams();
      if (ciudad) params.append("ciudad", ciudad);
      if (categoria) params.append("categoria", categoria);
      if (pagoMin) params.append("pagoMin", pagoMin);

      const resp = await fetch(`${API_URL}/turnos/buscar?${params.toString()}`);
      const data = await resp.json();
      const tbody = document.querySelector("#tablaTurnos tbody");
      tbody.innerHTML = "";

      data.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.titulo}</td>
          <td>${t.categoria}</td>
          <td>${t.fecha || ""}</td>
          <td>${t.direccion}</td>
          <td>${t.ciudad}</td>
          <td>$${t.pago.toLocaleString()}</td>
          <td>${t.empresa || ""}</td>
          <td>${
            usuarioActual?.rol === "trabajador"
              ? `<button onclick="abrirPostulacion(${t.id})">Postularse</button>`
              : ""
          }</td>`;
        tbody.appendChild(tr);
      });
    }

    async function crearTurno() {
      const turno = {
        titulo: document.getElementById("titulo").value,
        categoria: document.getElementById("categoriaPub").value,
        fecha: document.getElementById("fecha").value,
        direccion: document.getElementById("direccion").value,
        ciudad: document.getElementById("ciudadPub").value,
        pago: parseFloat(document.getElementById("pago").value),
        descripcion: document.getElementById("descripcion").value,
        empresa: usuarioActual?.nombreUsuario || ""
      };

      const resp = await fetch(`${API_URL}/turnos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(turno)
      });

      document.getElementById("pub-msg").textContent =
        resp.ok ? "‚úÖ Turno publicado correctamente." : "‚ùå Error al publicar.";
      if (resp.ok) buscarTurnos();
    }

    function abrirPostulacion(turnoId) {
      document.getElementById("formPostulacion").classList.remove("hidden");
      document.getElementById("overlay").classList.remove("hidden");
      document.getElementById("turnoId").value = turnoId;
    }

    function cerrarFormulario() {
      document.getElementById("formPostulacion").classList.add("hidden");
      document.getElementById("overlay").classList.add("hidden");
    }

    async function enviarPostulacion() {
      const postulacion = {
        turnoId: document.getElementById("turnoId").value,
        nombre: document.getElementById("nombre").value,
        email: document.getElementById("email").value,
        telefono: document.getElementById("telefono").value,
        experiencia: document.getElementById("experiencia").value,
        comentarios: document.getElementById("comentarios").value
      };

      const resp = await fetch(`${API_URL}/postulaciones`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(postulacion)
      });

      document.getElementById("post-msg").textContent =
        resp.ok ? "‚úÖ Postulaci√≥n enviada correctamente." : "‚ùå Error al enviar.";
      if (resp.ok) setTimeout(cerrarFormulario, 1500);
    }

    async function cargarPostulaciones() {
  // 1Ô∏è‚É£ Buscar los turnos publicados por la empresa actual
  const turnosResp = await fetch(`${API_URL}/turnos`);
  const turnos = await turnosResp.json();

  // Filtramos solo los turnos creados por esta empresa
  const turnosEmpresa = turnos.filter(t => t.empresa === usuarioActual.nombreUsuario);

  const tbody = document.querySelector("#tablaPostulaciones tbody");
  tbody.innerHTML = "";

  // 2Ô∏è‚É£ Para cada turno, obtener sus postulaciones
  for (const turno of turnosEmpresa) {
    const resp = await fetch(`${API_URL}/postulaciones/${turno.id}`);
    const postulaciones = await resp.json();

    postulaciones.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${turno.titulo}</td>
        <td>${p.nombre}</td>
        <td>${p.email}</td>
        <td>${p.telefono}</td>
        <td>${p.experiencia}</td>
        <td>${p.comentarios}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  if (tbody.innerHTML.trim() === "") {
    tbody.innerHTML = "<tr><td colspan='6'>No hay postulaciones a√∫n.</td></tr>";
  }
}


    function cerrarSesion() {
      if (confirm("¬øSeguro que deseas cerrar sesi√≥n?")) {
        usuarioActual = null;
        window.location.href = "index.html";
      }
    }
  </script>
</body>
</html>
